# وصف متكامل لعملية اختيار الفائزين وإدارة بيانات المسابقات

## المرحلة الأولى: إرسال المسابقة وإشعار الانتهاء
- تبدأ العملية بإرسال المسابقة إلى وكيل معيّن وربطها بـ `Agent ID` و`Contest ID` فريدين، مع تحديد مدة واضحة (مثل: يوم كامل أو 10 ثوانٍ للتجربة).
- تاريخ الانتهاء يحسب تلقائياً في الخادم ويخزن في الحقل `ends_at`.
- عند الوصول إلى تاريخ الانتهاء، يقوم المجدول بتحديث حالة المسابقة إلى `awaiting_winners` ويحدد وقت إرسال طلب اختيار الفائزين في الحقل `winner_request_sent_at`، ويُرسل رسالة تلقائية للوكيل عبر تيليجرام (إن وُجد `telegram_chat_id`).

الصيغة المقترحة لرسالة الإشعار:
- "انتهت مدة المشاركة للمسابقة. يرجى تزويدنا برابط منشور المسابقة ليتم اختيار الفائزين والتحقق من بياناتهم."

## المرحلة الثانية: احتساب الالتزام وتلقي بيانات المشاركين/الفائزين
1) معيار الالتزام (Compliance Metric)
- يُحسب الالتزام اعتماداً على الفاصل الزمني بين وقت إرسال طلب اختيار الفائزين `winner_request_sent_at` ووقت اختيارهم الفعلي `winners_selected_at`.
- التعريف الرياضي: إذا كان الفارق الزمني Δt = `winners_selected_at − winner_request_sent_at`:
  - High Compliance إذا كان Δt ≤ 24 ساعة.
  - Low Compliance إذا كان Δt > 24 ساعة.

2) صيغة إدخال مشاركي المسابقة من الوكيل
- يرسل الوكيل قائمة المشاركين بالصيغة التالية: `[اسم المشارك] — [رقم الحساب]`.
- أمثلة:
  - `1- فرحان سمير محمود — 4155987`
  - `2- سالم عبد العزيز فهد — 4099211`

## المرحلة الثالثة: التسجيل والاختيار الداخلي (Roulette)
- يتم إدخال كل المشاركين في صفحة العجلة `winner-roulette.html`.
- عند توقف العجلة على فائز، تظهر نافذة منبثقة تحتوي:
  - اسم الوكيل ورقم الوكالة (يظهر في أعلى الصفحة بعد اختيار الوكيل)
  - اسم الفائز ورقم حسابه
  - حقل بريد إلكتروني للفائز (إدخال إلزامي للاعتماد)
  - نوع وقيمة الجائزة تعرض آلياً حسب توزيع المسابقة (بونص تداولي/إيداع)
- عند الضغط على "اعتماد" تتم إضافة الفائز مؤقتاً لقائمة الفائزين في الجلسة.
- عند اكتمال العدد المطلوب، يظهر إشعار "تم اختيار جميع الفائزين" مع زر "تصدير الفائزين".

## المرحلة الرابعة: التصدير والتخزين النهائي في قاعدة البيانات
- زر "تصدير الفائزين" يقوم بمناداة مسار الخادم `POST /api/agents/:agentId/winners/import`.
- يتم تخزين كل فائز في مجموعة `winners` مرتبطاً بـ `agent_id` و`competition_id`، مع حفظ بريد الفائز ونوع/قيمة الجائزة داخل حقل `meta`.
- عند أول حفظ للفائزين، يحدد الخادم الحقل `winners_selected_at` ومواءمة `processed_at` لعرض تاريخ التأكيد في واجهة الوكيل.

## المرحلة الخامسة: واجهة عرض مسابقات الوكيل
- صفحة `agent-competitions.html` تعرض جميع مسابقات الوكيل مع الحقول:
  - `Contest ID`، سؤال/عنوان المسابقة، تاريخ الإرسال (`createdAt`)، تاريخ الانتهاء (`ends_at`)، تاريخ التأكيد (`processed_at`)، الالتزام (`is_compliant` + تفاصيل)، المشاهدات، التفاعلات، المشاركات، حالة المسابقة، إجراءات.
- منطق الإكمال:
  - إذا وُجد اختيار فائزين (`winners_selected_at`) قبل تعبئة `views_count` و`reactions_count` و`participants_count`، تظهر رسالة توجيهية للمستخدم لإدخال هذه الإحصائيات عبر نافذة الإدخال (فتحها بالنقر على شارة "بانتظار الفائزين").
- المسابقات المكتملة يمكن عرضها في قسم مطوي (Collapsible) للتمييز البصري.

## الحقول الرئيسية ذات الصلة في قاعدة البيانات
- Competition:
  - `ends_at`: تاريخ انتهاء المسابقة
  - `status`: حالة المسابقة `sent|active|awaiting_winners|completed|archived`
  - `winner_request_sent_at`: وقت إرسال طلب اختيار الفائزين (يُحدّده المجدول)
  - `winners_selected_at`: وقت أول اعتماد للفائزين (يُحدّده الخادم عند أول استيراد)
  - `processed_at`: يظهر في الواجهة كتاريخ التأكيد
  - `views_count`, `reactions_count`, `participants_count`: إحصائيات الأداء
- Winner:
  - `agent_id`, `competition_id`, `name`, `account_number`, `selected_at`, `meta.email`, `meta.prize_type`, `meta.prize_value`

## نقاط تكامل مهمة
- المجدول (Scheduler): ينقل المسابقة من `sent` إلى `awaiting_winners` عند الانتهاء ويحدد `winner_request_sent_at` ويرسل رسالة تيليجرام.
- الاستيراد (Import): يضبط `winners_selected_at` و`processed_at` عند أول تسجيل للفائزين ويزيد العدادات.
- الملخص (Agent Competitions Summary): يحسب `is_compliant` و`compliance_details` ديناميكياً لإظهار الحالة في الواجهة.
